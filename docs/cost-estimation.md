# Claude API 비용 추정 가이드

이 문서는 appium-mcp를 사용할 때 발생하는 Claude API 비용을 추정하는 가이드입니다.

## 이미지 토큰 계산 방식

Claude는 이미지를 **512x512 타일**로 분할하고, 각 타일당 약 **768 토큰**을 사용합니다.

### 이미지 리사이즈 최적화 효과 (v1.3+)

기본 설정: **최대 너비 480px, JPEG 60% 품질**

| 기기 예시 | 원본 크기 | 최적화 후 | 타일 수 | 토큰 |
|----------|----------|----------|---------|------|
| Android 420dpi | 1080 x 2400 | 480 x 1067 | 2 | ~1,536 |
| iPhone 15 Pro | 1179 x 2556 | 480 x 1042 | 2 | ~1,536 |

**최적화 전**: ~11,520 토큰/이미지
**최적화 후**: ~1,536 토큰/이미지
**절감율**: 약 87% (7.5배 감소)

### 이미지 최적화 설정 (환경변수)

```bash
# 최대 이미지 너비 (기본: 480px)
export MOBILE_MCP_MAX_IMAGE_WIDTH=480

# JPEG 품질 (기본: 60, 범위: 1-100)
export MOBILE_MCP_JPEG_QUALITY=60
```

**권장 설정:**

| 용도 | MAX_WIDTH | QUALITY | 토큰 | 비고 |
|------|-----------|---------|------|------|
| 일반 UI 분석 | 480 | 60 | ~1,536 | 기본값, 대부분 충분 |
| 세밀한 분석 | 600 | 75 | ~2,304 | 작은 텍스트 확인 필요시 |
| 최소 비용 | 400 | 50 | ~1,536 | 큰 버튼/아이콘 위주 |
| 고품질 | 800 | 85 | ~3,072 | 디자인 검증용 |

## Claude API 가격 (2024년 기준)

| 모델 | Input (1M 토큰) | Output (1M 토큰) |
|------|----------------|------------------|
| Claude 3.5 Sonnet | $3 | $15 |
| Claude 3 Haiku | $0.25 | $1.25 |

## 호출당 토큰 사용량

| 항목 | 토큰 수 |
|------|---------|
| 시스템 프롬프트 | ~500 |
| 스크린샷 (최적화 후) | ~1,536 |
| 요소 목록 (list_elements) | ~1,000 |
| AI 응답 | ~300 |
| **총 Input** | **~3,000** |
| **총 Output** | **~300** |

## 시나리오별 예상 비용

### Claude 3.5 Sonnet 기준

#### 1. 간단한 앱 테스트 (20회 호출)
```
Input:  20 × 3,000 = 60,000 토큰 → $0.18
Output: 20 × 300 = 6,000 토큰   → $0.09
────────────────────────────────────
총 비용: ~$0.27 (약 400원)
```

#### 2. E2E 테스트 시나리오 (50회 호출)
```
Input:  50 × 3,000 = 150,000 토큰 → $0.45
Output: 50 × 300 = 15,000 토큰    → $0.23
────────────────────────────────────
총 비용: ~$0.68 (약 1,000원)
```

#### 3. 복잡한 자동화 (200회 호출)
```
Input:  200 × 3,000 = 600,000 토큰 → $1.80
Output: 200 × 300 = 60,000 토큰    → $0.90
────────────────────────────────────
총 비용: ~$2.70 (약 4,000원)
```

### Claude 3 Haiku 기준 (저비용)

간단한 UI 탐색에는 Haiku도 충분할 수 있습니다:

```
E2E 테스트 (50회):
Input:  $0.04
Output: $0.02
─────────────
총 비용: ~$0.06 (약 90원)
```

## 최적화 전후 비용 비교

| 시나리오 | 최적화 전 | 최적화 후 | 절감율 |
|----------|----------|----------|--------|
| 간단한 테스트 (20회) | ~$2.00 | ~$0.27 | 87% |
| E2E 테스트 (50회) | ~$5.00 | ~$0.68 | 87% |
| 복잡한 자동화 (200회) | ~$20.00 | ~$2.70 | 87% |

## 비용 절감 팁

### 1. 요소 목록 최적화 (v1.3+)

요소 목록이 컴팩트 포맷으로 반환됩니다:
- 빈 요소 (텍스트/라벨/identifier 없음) 자동 필터링
- 중복 필드 제거 (text와 같은 label 생략)
- 좌표 형식 단순화: `rect: [x, y, w, h]`

**예시:**
```json
// 이전 (장황한 형식)
{"type":"Button","text":"Login","label":"Login","name":"Login","value":null,"identifier":"btn_login","coordinates":{"x":100,"y":200,"width":80,"height":40}}

// 현재 (컴팩트 형식)
{"type":"Button","text":"Login","id":"btn_login","rect":[100,200,80,40]}
```

**토큰 절감:** 요소당 약 40-60% 감소

### 2. 도구 선택 전략

| 상황 | 권장 도구 | 토큰 절약 |
|------|----------|----------|
| 요소 위치만 필요 | `list_elements_on_screen` | 스크린샷 없이 ~1,500 토큰 절약 |
| 요소 + 화면 확인 | `get_ui_state` (병렬 처리) | 별도 호출 대비 50% 절약 |
| 단순 액션 확인 | 스크린샷 생략 | ~1,500 토큰 절약 |

### 3. 대화 효율화 (속도 + 비용)

- **명확한 지시**: "버튼 클릭" 대신 "Login 버튼 클릭"처럼 구체적으로
- **단일 목표**: 한 번에 하나의 목표만 지시
- **불필요한 확인 생략**: "잘 됐나 스크린샷 보여줘" 대신 다음 작업 바로 지시

### 4. 모델 선택

| 작업 유형 | 권장 모델 | 비용 |
|----------|----------|------|
| 복잡한 분석/테스트 | Claude 3.5 Sonnet | $3/M in |
| 단순 UI 탐색 | Claude 3 Haiku | $0.25/M in |
| 반복 자동화 | Haiku + 스크립트 | 최저 |

### 5. 실제 사용 패턴 최적화

```
# 비효율적 (토큰 낭비)
1. 스크린샷 → 분석 → 요소 목록 → 클릭 → 스크린샷 → 확인

# 효율적 (토큰 절약)
1. get_ui_state (스크린샷+요소 병렬) → 클릭 → 다음 액션
```

### 6. 캐싱 및 배치 처리

- **결과 캐싱**: 동일 화면 반복 분석 시 이전 결과 재사용
- **배치 요청**: 여러 작업을 한 프롬프트로 요청 (시스템 프롬프트 공유)

## 기술적 구현

### Android 좌표 시스템
- density 기반 scale 계산: `scale = density / 160`
- 예: 420dpi → scale = 2.625
- 스크린샷: 픽셀 크기 / scale = 논리적 크기로 리사이즈
- 요소 좌표: 픽셀 / scale = 논리적 좌표로 변환
- tap/swipe: 논리적 좌표 × scale = 픽셀 좌표로 변환

### iOS 좌표 시스템
- WDA가 point(논리적) 단위 사용
- 스크린샷: 픽셀 크기 / scale = point 크기로 리사이즈
- 요소 좌표: point 단위로 직접 반환
- tap/swipe: point 좌표 그대로 사용
